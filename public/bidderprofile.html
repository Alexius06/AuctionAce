<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile Page</title>
    <link rel="icon" href="/favicon.png" type="image/png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.0/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Reem+Kufi&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Reem Kufi", sans-serif;
        background: radial-gradient(circle at center, #c9c9c9, #606060);
        overflow-x: hidden;
      }

      .nav-link:hover {
        color: #c7ae6a;
      }

      .page::-webkit-scrollbar {
        width: 8px;
        /* Slim scrollbar width */
      }

      .page::-webkit-scrollbar-track {
        background: transparent;
        
      }

      .page::-webkit-scrollbar-thumb {
        background: #bfa75d;
        /* Gold color */
        border-radius: 4px;
      
      }

      .page::-webkit-scrollbar-thumb:hover {
        background: #a68e4d;
        
      }

      .popup-hidden {
            transform: translateY(-100%);
            opacity: 0;
        }

        .popup-visible {
            transform: translateY(0);
            width: 100%;
            opacity: 1;
        }
    </style>
  </head>

  <body class="bg-red-500 flex justify-center items-center min-h-screen">
    <div class="relative w-full max-w-6xl">
      <!-- Background Container -->
      <div
        class="relative bg-gradient-to-b from-gray-200 to-gray-50 rounded-lg shadow-lg overflow-hidden"
      >
        
        <div
          class="absolute top-0 left-0 w-full h-64 bg-gray-300 opacity-50 transform scale-125 -rotate-6"
        ></div>

        
        <nav class="absolute top-0 w-full bg-transparent px-6 py-4 z-50">
          <ul class="flex space-x-4 text-white">
            <li>
              <a
                href="/home.html"
                class="hover:underline text-[#606060] nav-link"
                >Home</a
              >
            </li>
            <button
              onclick="openEditProfilePopup()"
              class="absolute top-4 right-4 text-[#606060] px-4 py-2 rounded-full shadow-md hover:shadow-xl bg-[#c7ae6a]"
            >
              <i class="fas fa-user-pen"></i>Edit
            </button>
            <!-- Add more navbar items here -->
          </ul>
        </nav>

        <div
              id="popupMessage"
              class="fixed top-0  w-full bg-green-500 text-white p-4 text-center shadow-md popup-hidden z-50 transition-transform duration-500"
            >
              <span id="popupContent"></span>
      </div>
        <!-- edit profile section -->
        <div
          id="editProfilePopup"
          class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center transition-opacity duration-500 ease-in-out z-50"
        >
          <div
            class="bg-white rounded-lg shadow-lg p-6 w-96 transform transition-transform duration-500 ease-in-out scale-95"
          >
            <h2 class="text-xl font-bold mb-4">Edit Profile</h2>
            <form id="editProfileForm">
              <div class="mb-4">
                <label
                  for="firstname"
                  class="block text-sm font-medium text-gray-700"
                  >First Name</label
                >
                <input
                  type="text"
                  id="firstname"
                  name="firstname"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>

              <div class="mb-4">
                <label
                  for="lastname"
                  class="block text-sm font-medium text-gray-700"
                  >Last Name</label
                >
                <input
                  type="text"
                  id="lastname"
                  name="lastname"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>

              <div class="mb-4">
                <label
                  for="phonenumber"
                  class="block text-sm font-medium text-gray-700"
                  >Phone Number</label
                >
                <input
                  type="text"
                  id="phone-number"
                  name="phonenumber"
                  class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                  required
                />
              </div>
              <p id="error-message" class="text-red-600 text-center hidden"></p>
              <div class="flex justify-end">
                <button
                  type="button"
                  id="cancelButton"
                  class="mr-2 bg-gray-500 text-white px-4 py-2 rounded-md"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="bg-[#c7ae6a] text-white px-4 py-2 rounded-md"
                >
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- User Info Section -->
        <div
          class="relative z-10 pt-24 flex flex-col items-left pl-[8rem] overflow-y-scroll page"
        >
          <!-- Profile Image -->
          <div
            id="profileicon"
            class="w-32 h-32 rounded-full bg-[#c7ae6a] bg-opacity-30 flex text-3xl font-bold justify-center items-center text-center overflow-hidden cursor-pointer"
          >
            T
          </div>

          <!-- User Details -->
          <div class="text-left mt-4">
            <h1 id="fullname" class="text-2xl font-semibold"></h1>
            <p id="username" class="text-gray-600">
              <i class="fa-light fa-at"></i>user
            </p>
            <p class="text-sm mt-2">Bidder</p>
            <p class="flex items-center text-sm text-gray-500 mt-2">
              <span id="phonenumber"
                ><i class="fa-duotone fa-solid fa-phone mr-2"></i>0000000</span
              >
            </p>
            <p class="flex items-center text-sm text-gray-500 mt-2">
              <span id="email"
                ><i class="fa-regular fa-envelope mr-2"></i
                >your@example.com</span
              >
            </p>
            <p class="flex items-center text-sm text-gray-500 mt-2">
              <span id="joined"
                ><i class="mr-2 fa-solid fa-calendar"></i>datetime</span
              >
            </p>
          </div>

          <!-- coming soon -->
          <div
            id="comingSoonModal"
            class="fixed inset-0 flex items-center z-50 justify-center bg-black bg-opacity-50 hidden"
          >
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
              <h2 class="text-lg font-semibold text-gray-900 mb-4">
                Coming Soon!
              </h2>
              <p class="text-gray-700 mb-6">
                Payment functionality will be available soon.
              </p>
              <div class="flex justify-end">
                <button
                  onclick="closeComingSoon()"
                  class="px-4 py-2 bg-[#c7ae6a] text-white rounded hover:bg-[#b08f5d] transition"
                >
                  Close
                </button>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="mt-8 w-full pr-[10rem]">
            <ul class="flex border-b-2 border-gray-200 text-sm">
              <li
                id="AuctionHistory"
                onclick="setActiveTab('AuctionHistory')"
                class="mr-4 pb-2 cursor-pointer transition-colors duration-300 ease-in-out"
              >
                Auction History
              </li>
              <li
                id="WonItems"
                onclick="setActiveTab('WonItems')"
                class="mr-4 pb-2 cursor-pointer transition-colors duration-300 ease-in-out"
              >
                Won Items
              </li>
              <li
                id="PaymentHistory"
                onclick="setActiveTab('PaymentHistory')"
                class="mr-4 pb-2 cursor-pointer transition-colors duration-300 ease-in-out"
              >
                Payment History
              </li>
              <li
                id="Review"
                onclick="setActiveTab('Review')"
                class="pb-2 cursor-pointer transition-colors duration-300 ease-in-out"
              >
                Review
              </li>
            </ul>

            
            <!-- Table Section -->
            <div
              class="mt-4 transition-opacity duration-500 ease-in-out container tabcontent"
              id="AuctionHistoryTab"
            >
              <div class="h-[122px] overflow-y-scroll page">
                <table class="table-auto w-full text-left text-gray-500">
                  <thead class="mb-1">
                    <tr
                      class="text-xs uppercase text-gray-400 sticky top-0 bg-gray-200"
                    >
                      <th class="px-4 py-2">Auction Item</th>
                      <th class="px-4 py-2">Bid Amount</th>
                      <th class="px-4 py-2">Bid Date</th>
                    </tr>
                  </thead>
                  <tbody id="auctionHistoryTableBody">
                    <!-- Example Row -->
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2">Vintage Vase</td>
                      <td class="px-4 py-2">$150</td>
                      <td class="px-4 py-2">2024-10-10 14:30</td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2">Antique Clock</td>
                      <td class="px-4 py-2">$200</td>
                      <td class="px-4 py-2">2024-10-11 10:15</td>
                    </tr>
                    <!-- More rows will be dynamically generated here -->
                  </tbody>
                </table>
              </div>
            </div>

            <div
              class="mt-4 transition-opacity duration-500 ease-in-out container tabcontent"
              id="WonItemsTab"
            >
              <div class="h-[122px] overflow-y-scroll page">
                <table class="table-auto w-full text-left text-gray-500">
                  <thead class="mb-1">
                    <tr
                      class="text-xs uppercase text-gray-400 sticky top-0 bg-gray-200"
                    >
                      <th class="px-4 text-center py-2">Auction Item</th>
                      <th class="px-4 text-center py-2">Payments</th>
                    </tr>
                  </thead>
                  <tbody id="WonitemsBody">
                    <!-- Dynamic rows will be generated here -->
                  </tbody>
                </table>
              </div>
            </div>
            <div
              class="mt-4 transition-opacity duration-500 ease-in-out container tabcontent"
              id="PaymentHistoryTab"
            >
              <div class="h-[122px] overflow-y-scroll page">
                <div id="PaymentHistoryBody">
                  <p
                    class="text-gray flex items-center justify-center text-4xl"
                  >
                    Coming Soon!
                  </p>
                </div>
              </div>
            </div>
            <div
              class="mt-4 transition-opacity duration-500 ease-in-out container tabcontent"
              id="ReviewTab"
            >
              <form
                class="table-auto w-full text-left text-gray-500"
                id="reviewform"
              >
                <label
                  for="Review"
                  class="block text-sm font-medium text-gray-700"
                  >Leave A Review</label
                >
                <div>
                  <textarea
                    id="reviewText"
                    name="review_text"
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2 h-[10rem] overflow-y-scroll page focus:border-[#c7ae6a] focus:ring-[#c7ae6a] focus:outline-none"
                    rows="3"
                    required
                  ></textarea>
                  <div class="rating flex justify-center space-x-1 text-2xl">
                    <span
                      class="star cursor-pointer text-gray-400 transition-all duration-30"
                      data-value="1"
                      onclick="setRating(1)"
                      >&#9733;</span
                    >
                    <span
                      class="star cursor-pointer text-gray-400 transition-all duration-30"
                      data-value="2"
                      onclick="setRating(2)"
                      >&#9733;</span
                    >
                    <span
                      class="star cursor-pointer text-gray-400 transition-all duration-30"
                      data-value="3"
                      onclick="setRating(3)"
                      >&#9733;</span
                    >
                    <span
                      class="star cursor-pointer text-gray-400 transition-all duration-30"
                      data-value="4"
                      onclick="setRating(4)"
                      >&#9733;</span
                    >
                    <span
                      class="star cursor-pointer text-gray-400 transition-all duration-30"
                      data-value="5"
                      onclick="setRating(5)"
                      >&#9733;</span
                    >
                  </div>

                  <!-- Hidden input to store the rating value -->
                  <input
                    type="hidden"
                    name="rating"
                    id="ratingValue"
                    value="1"
                  />
                  <button
                    type="submit"
                    class="bg-[#c7ae6a] hover:bg-[#bfa75d] rounded-lg px-2 mt-1"
                  >
                    Submit
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script> 
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
      // fetch user  details
      var userId;
      document.addEventListener("DOMContentLoaded", () => {
        userId = getUserIdFromToken();
        if (userId) {
          fetchUserDetails(userId);
        } else {
          console.error("User ID could not be extracted from token.");
          // Optionally redirect to login if no token is present
        }
      });

      async function fetchUserDetails(userId) {
        try {
          const response = await fetch(
            `http://localhost:3000/users/${userId}`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          if (!response.ok) {
            throw new Error("Failed to fetch user details");
          }

          const user = await response.json();
          const firstLetter = user.firstname.charAt(0);
          const dateperiod = new Date(user.createdAt);
          const options = { year: "numeric", month: "short", day: "numeric" };
          const date = dateperiod.toLocaleDateString(undefined, options);

          document.getElementById("profileicon").textContent = firstLetter;
          document.getElementById("fullname").textContent =
            user.firstname + " " + user.lastname;
          document.getElementById("username").childNodes[1].nodeValue =
            user.username;
          document.getElementById("phonenumber").childNodes[1].nodeValue =
            user.phoneNumber;
          document.getElementById("email").childNodes[1].nodeValue = user.email;
          document.getElementById(
            "joined"
          ).childNodes[1].nodeValue = `Joined  ${date}`;
        } catch (error) {
          console.error("Error fetching user details:", error);
        }
      }

      function getUserIdFromToken() {
        const tokenCookie = document.cookie
          .split("; ")
          .find((row) => row.startsWith("Btoken="));
        if (!tokenCookie) {
          console.error("No token found in cookies.");
          window.location.href = "/auth.html?section=login";
          return null; // Token is missing
        }
        console.log("tokencookie:" + tokenCookie);

        const token = tokenCookie.split("=")[1];
        if (!token) {
          console.error("Token is malformed or missing.");
          window.location.href = "/auth.html?section=login";
          return null;
        }
        console.log("token:" + token);
        const currentTime = Math.floor(Date.now() / 1000);
        try {
          const decoded = jwt_decode(token);
          if (decoded.exp && decoded.exp < currentTime) {
            window.location.href = "/auth.html?section=login";
          } else {
            return decoded.id;
          }
        } catch (error) {
          window.location.href = "/auth.html?section=login";
          console.error("Error decoding token:", error);
          return null; // Return null if decoding fails
        }
      }

      //edit  profile  popup
      const editProfilePopup = document.getElementById("editProfilePopup");
      const cancelButton = document.getElementById("cancelButton");

      function openEditProfilePopup() {
        editProfilePopup.classList.remove("hidden");
        setTimeout(() => {
          editProfilePopup.classList.remove("opacity-0");
        }, 10);
      }

      cancelButton.addEventListener("click", () => {
        editProfilePopup.classList.add("opacity-0");
        setTimeout(() => {
          editProfilePopup.classList.add("hidden");
        }, 500);
      });

      // edit form  submit
      document
        .getElementById("editProfileForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault(); // Prevent form from submitting the traditional way

          const firstname = document.getElementById("firstname").value.trim();
          const lastname = document.getElementById("lastname").value.trim();
          const phoneNumber = document
            .getElementById("phone-number")
            .value.trim();
          const phoneRegex = /^[0-9]{11}$/;
          const formData = {
            firstname: firstname,
            lastname: lastname,
            phoneNumber: phoneNumber,
          };
          if (phoneRegex.test(phoneNumber)) {
            try {
              const response = await fetch(
                `http://localhost:3000/users/${userId}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify(formData),
                }
              );

              if (response.ok) {
                const result = await response.json();
                document.getElementById("error-message").textContent =
                  "Profile Updated Successfully";
                document
                  .getElementById("error-message")
                  .classList.add("text-green-600");
                document
                  .getElementById("error-message")
                  .classList.remove("hidden", "text-red-600");
                setTimeout(() => {
                  editProfilePopup.classList.add("hidden"); // Close popup
                }, 500);
              } else {
                throw new Error("Failed to update profile");
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred while updating the profile.");
            }
          } else {
            document.getElementById("error-message").textContent =
              "Please enter a valid 11-digit phone number!";
            document.getElementById("error-message").classList.remove("hidden");
          }
        });

      function setActiveTab(tabId) {
        // Get all list items
        const tabs = document.querySelectorAll("ul li");
        const tabcontent = document.querySelectorAll(".tabcontent");

        // Remove the active border class from all tabs
        tabs.forEach((tab) => {
          tab.classList.remove("border-b-2", "border-black");
          const contentElement = document.getElementById(`${tabId}Tab`);
          console.log(`${tabId}Tab`);
          // e.g., AuctionHistoryTab
          if (contentElement) {
            contentElement.classList.add("hidden"); // Hide all content sections
          }
        });
        tabcontent.forEach((tab) => tab.classList.add("hidden"));

        // Add the active border class to the selected tab
        const activeTab = document.getElementById(tabId);
        const activeTabContent = document.getElementById(`${tabId}Tab`);
        console.log(activeTab);
        activeTab.classList.add("border-b-2", "border-black");
        activeTabContent.classList.remove("hidden");
      }

      function setRating(rating) {
        // Get all stars
        const stars = document.querySelectorAll(".star");

        // Update each star's appearance based on the selected rating
        stars.forEach((star) => {
          const starValue = parseInt(star.getAttribute("data-value"));

          // If the star's value is less than or equal to the rating, activate it
          if (starValue <= rating) {
            star.classList.add("text-yellow-500"); // Tailwind class for active star
            star.classList.remove("text-gray-400"); // Remove inactive color
          } else {
            star.classList.remove("text-yellow-500"); // Remove active color
            star.classList.add("text-gray-400"); // Tailwind class for inactive star
          }
        });

        // Update hidden input value
        const ratingInput = document.getElementById("ratingValue");
        ratingInput.value = rating; // Set the hidden input's value to the current rating

        console.log("Selected rating:", rating);
      }

      // Call setActiveTab on page load to set the default active tab (optional)
      window.onload = function () {
        setActiveTab("AuctionHistory");
        fetchAuctionHistory();
        fetchwonitems();
        setRating(1);
      };

      async function fetchAuctionHistory() {
        try {
          const response = await fetch(`/bids/user/${userId}`); // API endpoint for fetching bids history
          const auctionHistory = await response.json();

          const tableBody = document.getElementById("auctionHistoryTableBody");
          tableBody.innerHTML = ""; // Clear existing rows

          auctionHistory.data.forEach((Bid) => {
            const row = document.createElement("tr");
            row.classList.add("hover:bg-gray-50");
            row.innerHTML = `
                              <td class="px-4 py-2 border">${
                                Bid.itemId.Itemname
                              }</td>
                              <td class="px-4 py-2 border">${Bid.bidAmount}</td>
                              <td class="px-4 py-2 border">${new Date(
                                Bid.createdAt
                              ).toLocaleString()}</td>
                          `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error fetching auction history:", error);
        }
      }

      //
      function showComingSoonModal() {
        const modal = document.getElementById("comingSoonModal");
        modal.classList.remove("hidden"); // Remove the 'hidden' class to display the modal
      }

      // Function to close the modal
      function closeComingSoon() {
        const modal = document.getElementById("comingSoonModal");
        modal.classList.add("hidden"); // Add the 'hidden' class to hide the modal
      }

      async function fetchwonitems() {
        const response = await fetch(`/bids/wonitems/${userId}`); // API endpoint for fetching bids history
        const data = await response.json();

        console.log(data);
        const wonItemsBody = document.getElementById("WonitemsBody");

        // Clear any existing rows
        wonItemsBody.innerHTML = "";

        if (data.data.length === 0) {
          wonItemsBody.innerHTML =
            '<tr><td colspan="2" class="text-center py-4">No won items yet!</td></tr>';
        } else {
          data.data.forEach((bid) => {
            const row = document.createElement("tr");
            row.classList.add("hover:bg-gray-50");

            // Create the item cell with image and name
            const itemCell = document.createElement("td");
            itemCell.classList.add("px-4", "py-2", "w-1/2");
            itemCell.innerHTML = `
                                  <div class="flex justify-center items-center">
                                      <img src="${bid.itemImg}" alt="${bid.itemName}" class="w-12 h-12 mr-2 rounded-lg object-cover" />
                                      <span>${bid.itemName}</span>
                                  </div>
                              `;

            // Create the payment button cell
            const paymentCell = document.createElement("td");
            paymentCell.classList.add("px-4", "py-2", "w-1/2", "text-center");
            const paymentButton = document.createElement("button");
            paymentButton.classList.add(
              "bg-[#c7ae6a]",
              "text-white",
              "px-4",
              "py-2",
              "rounded"
            );
            paymentButton.innerText = "Make Payment";
            paymentButton.onclick = () => showComingSoonModal(); // Function to show the coming soon modal

            paymentCell.appendChild(paymentButton);

            // Append cells to the row
            row.appendChild(itemCell);
            row.appendChild(paymentCell);

            // Append the row to the table body
            wonItemsBody.appendChild(row);
          });
        }
      }
      document
        .getElementById("reviewform")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent default form submission

          // Get the review text and rating values
          const reviewText = document.getElementById("reviewText").value;
          const rating = document.getElementById("ratingValue").value;

          // Validation: Check if review text is provided
          if (!reviewText.trim()) {
            alert("Please enter a review.");
            return;
          }

          // Prepare the data for submission
          const reviewData = {
            review_text: reviewText,
            rating: rating,
            userId: userId,
          };

          // Submit the review via Fetch API to the server
          fetch("http://localhost:3000/reviews", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(reviewData),
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Failed to submit review");
              }
            })
            .then((data) => {
              showPopup(`${data.message}`);

              document.getElementById("reviewform").reset(); // Clears the form fields
              setRating(1); // Resets stars back to 1 by default
            })
            .catch((error) => {
              console.error("Error:", error);
              alert(
                "There was an error submitting your review. Please try again."
              );
            });
        });

      function showPopup(message) {
        const popup = document.getElementById("popupMessage");
        const popupContent = document.getElementById("popupContent");
        console.log(message);
        // Set the message content
        if (message.toUpperCase().includes("FAILED")) {
          popup.classList.remove("bg-green-500");
          popup.classList.add("bg-red-500");
        } else {
          popup.classList.remove("bg-red-500");
          popup.classList.add("bg-green-500");
        }
        popupContent.textContent = message;

        // Show the popup with the transition effect
        popup.classList.remove("popup-hidden");
        popup.classList.add("popup-visible");

        // Automatically hide the popup after 1 second
        setTimeout(() => {
          hidePopup();
        }, 3000);
      }

      // Hide the popup when anywhere on the page is clicked
      document.body.addEventListener("click", hidePopup);

      // Hide the popup
      function hidePopup() {
        const popup = document.getElementById("popupMessage");
        popup.classList.remove("popup-visible");
        popup.classList.add("popup-hidden");
      }
    </script>
  </body>
</html>
